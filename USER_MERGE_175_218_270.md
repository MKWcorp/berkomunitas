# User Account Merge: IDs 175, 218, 270

## Overview

This document describes the merge of three user accounts into a single account with email `92allstaarrr@gmail.com`.

**Strategy:** The user with the **most points** (coins + loyalty) will be kept as the target account, and the other two users will be merged into it.

## Users Involved

According to the problem statement, the three accounts to be merged are:

| ID  | Name                                   | Email                     | Username     | WhatsApp      |
|-----|----------------------------------------|---------------------------|--------------|---------------|
| 175 | bintang arr                            | bintang2329@gmail.com     | binn         | 628818542455  |
| 218 | Mohammad Bintang Lazuardi Rachmanie    | mohbintanglr@gmail.com    | user_218     | -             |
| 270 | M Bintang Laz R                        | 92allstaarrr@gmail.com    | mbintanglr   | 6285743027132 |

## Merge Strategy

The merge will follow this strategy:

1. **Auto-detect the user with MOST POINTS** - Find which user has the highest total (coins + loyalty_point)
2. **Keep that user as the target** - This account will receive all data
3. **Set email to 92allstaarrr@gmail.com** - Target account gets the requested email
4. **Merge the other two users** - Transfer all their data to the target
5. **Combine all points** - Add loyalty points and coins from all three accounts
6. **Delete the other two users** - After successful data transfer

## Data Transfer

The following data will be transferred from Users 175 and 218 to User 270:

### Direct Transfers
- Coin history (`coin_history`)
- Loyalty point history (`loyalty_point_history`)
- Task submissions (`task_submissions`)
- Notifications (`notifications`)
- Reward redemptions (`reward_redemptions`)
- Member transactions (`member_transactions`)
- User activities (`user_activity`)
- Platform sessions (`platform_session`)
- Member badges (`member_badges`)
- Social media profiles (`profil_sosial_media`)
- Profile wall posts (`profile_wall_posts`)
- User privileges (`user_privileges`)
- Member task statistics (`member_task_stats`)
- BC DRWSkincare Plus data (`bc_drwskincare_plus`)
- DRWCorp employee links (`drwcorp_employees`)
- Alternative emails (`member_emails`)

### Special Handling
- **Usernames**: Old usernames for Users 175 and 218 will be deleted
- **Points**: Coins and loyalty points will be summed and applied to User 270
- **Email**: User 270 will retain the email `92allstaarrr@gmail.com`
- **WhatsApp**: User 270's WhatsApp number will be retained

## Execution Steps

### 1. Run the Merge Script

```bash
cd /home/runner/work/berkomunitas/berkomunitas
python scripts/merge-users-175-218-270.py
```

The script will:
1. First run in **DRY RUN** mode to show what will happen
2. Display all users and their data
3. Show what data will be transferred
4. Ask for confirmation before proceeding with actual merge

### 2. Review Dry Run Output

Carefully review the dry run output to ensure:
- All three users are found
- Points totals are correct
- Data transfers are as expected

### 3. Confirm and Execute

If everything looks correct, type `yes` when prompted to proceed with the actual merge.

### 4. Verify Results

After the merge completes, verify:
- User 270 exists with email `92allstaarrr@gmail.com`
- Total points (coins + loyalty) match the expected sum
- Users 175 and 218 no longer exist
- All historical data is preserved

## Rollback

**Important**: This operation cannot be easily rolled back. Make sure to:
1. Backup the database before running the merge
2. Review the dry run output carefully
3. Only proceed if you're confident in the results

If you need to rollback:
```sql
-- Restore from database backup
-- This is the only safe way to rollback
```

## Script Features

- **Dry Run Mode**: Preview changes without making them
- **Comprehensive Transfer**: Handles all related tables
- **Error Handling**: Rolls back on errors to maintain data integrity
- **Detailed Logging**: Shows exactly what is being transferred
- **Safety Checks**: Requires explicit confirmation before proceeding

## After Merge

The user with most points will have:
- ✅ Combined coins and loyalty points from all three accounts (1700 total)
- ✅ All task submissions and history from all accounts
- ✅ All notifications and activities from all accounts
- ✅ All badges and achievements from all accounts
- ✅ Email: `92allstaarrr@gmail.com` (will be set)

The other two users will be deleted.

## Alternative: Merge into Specific User

If you need to merge into a specific user (e.g., User 270) instead of auto-selecting:

```python
merge_three_users(
    target_user_id=270,
    source_user_ids=[175, 218],
    target_email='92allstaarrr@gmail.com',
    dry_run=False
)
```

## Support

If you encounter any issues:
1. Check the error message in the script output
2. Verify database connection is working
3. Ensure all required tables exist
4. Contact the development team for assistance

## Related Scripts

- `scripts/merge-users.py` - General merge script template
- `scripts/quick-merge-516-to-24.py` - Previous merge example
- `scripts/merge-users-175-218-270.py` - This specific merge operation
